# 51 — Git Operations & PR Flow

## Overview

When a workflow completes successfully (and the user approves, if configured), Jido Code commits the changes and opens a pull request. This document specifies the git operations, branch strategy, commit conventions, and PR creation flow.

## Branch Strategy

### Naming Convention
```
jido-code/<workflow-name>/<short-id>
```

Examples:
- `jido-code/implement-task/a1b2c3`
- `jido-code/fix-tests/d4e5f6`
- `jido-code/issue-42/g7h8i9`

The short ID is derived from the workflow run ID (first 6 chars).

### Branch Prefix
Configurable per project (default: `jido-code/`). Allows users to customize for their branch naming conventions.

### Base Branch
- Default: project's configured `default_branch` (usually `main`)
- Override: workflow input can specify a different base branch
- Always create from the latest commit on the base branch (fetch before branching)

## Git Operations Sequence

### Pre-Workflow
```bash
# Ensure workspace is on default branch and up to date
git checkout main
git fetch origin
git reset --hard origin/main
git clean -fd
```

### Post-Coding Agent (before approval)
```bash
# Create the feature branch
git checkout -b jido-code/implement-task/a1b2c3

# Stage all changes
git add -A

# Generate diff for approval UI
git diff --cached --stat
git diff --cached
```

### Post-Approval
```bash
# Commit with generated message
git commit -m "feat: implement REST API endpoint for users

Generated by Jido Code workflow: implement_task
Run ID: a1b2c3d4-e5f6-7890-abcd-ef1234567890"

# Push to origin
git push origin jido-code/implement-task/a1b2c3
```

### PR Creation (via GitHub API)
```json
POST /repos/{owner}/{repo}/pulls
{
  "title": "feat: implement REST API endpoint for users",
  "body": "## Summary\n\n[Auto-generated summary from coding agent]\n\n---\n\n*Generated by [Jido Code](https://github.com/agentjido/jido_code)*\n*Workflow: implement_task | Run: a1b2c3d4*",
  "head": "jido-code/implement-task/a1b2c3",
  "base": "main"
}
```

## Commit Message Conventions

### Format
```
<type>: <description>

<body>

Generated by Jido Code workflow: <workflow_name>
Run ID: <run_id>
```

### Types
| Type | When |
|------|------|
| `feat` | Implement Task workflow |
| `fix` | Fix Failing Tests workflow |
| `docs` | Documentation-only changes |
| `refactor` | Refactoring workflows |
| `test` | Test-only changes |
| `chore` | Maintenance workflows |

### Description Generation
- The commit description is generated by the coding agent during the implementation step
- If the agent doesn't provide one, fall back to the workflow's task input (truncated to 72 chars)
- The body includes a summary of what was changed

### Author
```
Author: Jido Code <jido-code@noreply.github.com>
```
Or configurable to use the admin user's identity.

## PR Body Template

```markdown
## Summary

{agent_summary}

## Changes

{file_change_summary}
- `lib/api/users.ex` — Added REST endpoint
- `test/api/users_test.exs` — Added endpoint tests

## Workflow Details

| Field | Value |
|-------|-------|
| Workflow | {workflow_name} |
| Agent | {agent_type} (e.g., Claude Code) |
| Model | {model_name} |
| Duration | {duration} |
| Cost | ${cost_usd} |
| Run ID | `{run_id}` |

## Test Results

{test_output_summary}

---

*Generated by [Jido Code](https://github.com/agentjido/jido_code)*
```

## Safety Checks

### Before Committing
1. **Non-empty diff**: verify there are actual changes to commit
2. **No secrets in diff**: scan diff for patterns matching API keys, tokens, passwords
3. **No binary files**: warn if binary files are in the diff (configurable)
4. **Diff size limit**: warn if diff exceeds configurable line count (default: 5000 lines)

### Before Pushing
1. **Branch doesn't exist**: verify the target branch name doesn't already exist on remote
2. **Base branch is current**: verify we branched from the latest commit
3. **Force push protection**: never use `--force`

### Before PR Creation
1. **No duplicate PR**: check for existing open PR with same branch name
2. **Protected branch check**: verify base branch allows PR merges
3. **Required checks**: note if the target branch has required status checks

## Dry-Run Mode

Workflows can be run in dry-run mode:
- All steps execute normally (including coding agent)
- Git operations stop after `git diff` (no commit, no push, no PR)
- The diff is stored as an artifact for review
- Useful for testing workflows without side effects

## Error Handling

| Error | Handling |
|-------|----------|
| Push rejected (branch exists) | Append random suffix, retry once |
| Push rejected (auth) | Refresh token, retry once |
| PR creation fails (422) | Log error, store branch name as artifact |
| Merge conflict on base | Abort, notify user, suggest manual rebase |
| Empty diff | Skip commit/PR, mark workflow as "no changes needed" |

## PR Lifecycle After Creation

Jido Code creates the PR and stores the URL. Post-creation management is minimal for MVP:

- **Store**: PR number, URL, branch name in `PullRequest` resource
- **Status sync**: periodically check if PR is merged/closed (or via webhook)
- **Cleanup**: optionally delete branch after PR is merged (configurable)

Phase 2 additions:
- Update PR on subsequent workflow runs
- Add review comments
- Auto-merge when checks pass (configurable)

## Configuration

Per-project overrides for git behavior:

```elixir
%{
  "branch_prefix" => "jido-code/",
  "commit_author_name" => "Jido Code",
  "commit_author_email" => "jido-code@noreply.github.com",
  "pr_draft" => false,
  "pr_labels" => ["automated", "jido-code"],
  "pr_assignees" => [],
  "delete_branch_on_merge" => true,
  "dry_run" => false,
  "max_diff_lines" => 5000
}
```
